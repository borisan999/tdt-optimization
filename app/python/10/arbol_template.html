<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Topología TDT Detallada</title>
    <!-- Importación de la librería vis-network para la visualización -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* Estilos CSS para la apariencia de la página y la red */
        body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #d3d3d3; margin: 0; overflow: hidden; }}
        #mynetwork {{ width: 100%; height: 100vh; background-color: #ffffff; }}
        .controls {{ position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }}
        .btn {{ background: white; border: 1px solid #ddd; width: 40px; height: 40px; border-radius: 8px; font-size: 18px; cursor: pointer; color: #555; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }}
        .btn:hover {{ background: #f8f8f8; color: #000; }}
        .legend-box {{ position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 13px; pointer-events: none; color: #333; }}
        .dot {{ height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }}
        .line-sample {{ display: inline-block; width: 30px; height: 2px; background: #aaa; vertical-align: middle; margin-right: 5px; }}
    </style>
</head>
<body>
    <!-- Leyenda de colores -->
    <div class="legend-box">
        <h3 style="margin:0 0 10px 0; color:#2C3E50;">Red TDT</h3>
        <div style="margin-bottom:4px;"><span class="dot" style="background:{c_cabecera}"></span> Cabecera</div>
        <div style="margin-bottom:4px;"><span class="dot" style="background:{c_troncal}"></span> Troncal</div>
        <div style="margin-bottom:4px;"><span class="dot" style="background:{c_bloque}"></span> Bloque</div>
        <div style="margin-bottom:4px;"><span class="dot" style="background:{c_piso}"></span> Piso</div>
        <div style="margin-bottom:4px;"><span class="dot" style="background:{c_apto}"></span> Apto</div>
        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:8px;">
            <span class="line-sample"></span> <b>Datos en Rama:</b><br/>Distancia (m) | Atenuación (dB)
        </div>
    </div>
    <!-- Contenedor para la red -->
    <div id="mynetwork"></div>
    <!-- Controles de zoom y ajuste -->
    <div class="controls">
        <button class="btn" onclick="zoomIn()" title="Acercar">+</button>
        <button class="btn" onclick="zoomOut()" title="Alejar">-</button>
        <button class="btn" onclick="fitAnimated()" title="Ajuste Automático">⛶</button>
    </div>
    <script type="text/javascript">
        // --- INICIALIZACIÓN DE DATOS PARA VIS.JS ---
        var nodesArray = {initial_nodes_json};
        var edgesArray = {initial_edges_json};
        var hierarchyMap = {hierarchy_map_json};
        
        // Creación de los DataSets de vis.js
        var nodes = new vis.DataSet(nodesArray);
        var edges = new vis.DataSet(edgesArray);
        
        var container = document.getElementById('mynetwork');
        var data = {{ nodes: nodes, edges: edges }};
        
        // --- OPCIONES DE CONFIGURACIÓN DE LA RED ---
        var options = {{
            layout: {{
                hierarchical: {{
                    direction: "UD", // Dirección de arriba hacia abajo
                    sortMethod: "directed",
                    levelSeparation: 170,
                    nodeSpacing: 180,
                    treeSpacing: 250,
                }}
            }},
            physics: {{ // Opciones de físicas para la estabilización inicial
                hierarchicalRepulsion: {{
                    nodeDistance: 180,
                    springLength: 120,
                    damping: 0.2
                }},
                stabilization: {{ iterations: 250 }}
            }},
            interaction: {{ // Interactividad del usuario
                hover: true,
                tooltipDelay: 200,
                zoomView: true
            }},
            edges: {{ // Estilo de las conexiones
                arrows: 'to',
                smooth: {{ type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.5 }},
                font: {{ color: '#333', size: 10, face: 'arial', background: '#ffffff', strokeWidth: 0, align: 'horizontal', multi: 'html' }},
                color: {{ color: '#aaa', highlight: '#555' }}
            }},
            nodes: {{ // Estilo de los nodos
                borderWidth: 1,
                shadow: true,
                font: {{ color: 'black' }}
            }}
        }};
        
        // Creación de la red
        var network = new vis.Network(container, data, options);
        
        // --- FUNCIONES DE INTERACTIVIDAD ---
        function zoomIn() {{ network.moveTo({{ scale: network.getScale() + 0.3, animation: true }}); }}
        function zoomOut() {{ network.moveTo({{ scale: network.getScale() - 0.3, animation: true }}); }}
        function fitAnimated() {{ network.fit({{ animation: {{ duration: 800, easingFunction: 'easeInOutQuad' }} }}); }}
        
        // Evento de clic en un nodo para expandir o colapsar
        network.on("click", function (params) {{
            if (params.nodes.length === 0) return; // Si no se hace clic en un nodo, no hacer nada.
            var nodeId = params.nodes[0];
            if (hierarchyMap.hasOwnProperty(nodeId)) {{
                var children = hierarchyMap[nodeId];
                if (children.length === 0) return;
                
                // Comprobar si el nodo está expandido o colapsado.
                var firstChildId = children[0].node.id;
                var isExpanded = nodes.get(firstChildId);
                
                if (isExpanded) {{
                    collapseNode(nodeId);
                }} else {{
                    expandNode(nodeId);
                }}
            }}
        }});
        
        // Función para añadir los hijos de un nodo al grafo.
        function expandNode(parentId) {{
            if (!hierarchyMap[parentId]) return;
            var newNodes = []; 
            var newEdges = [];
            hierarchyMap[parentId].forEach(function(child) {{ 
                newNodes.push(child.node); 
                newEdges.push(child.edge); 
            }});
            nodes.add(newNodes); 
            edges.add(newEdges);
            setTimeout(fitAnimated, 300); // Ajustar la vista después de expandir
        }}
        
        // Función para eliminar todos los descendientes de un nodo del grafo.
        function collapseNode(parentId) {{
            var descendants = getAllDescendants(parentId);
            nodes.remove(descendants);
            setTimeout(fitAnimated, 300); // Ajustar la vista después de colapsar
        }}
        
        // Función recursiva para obtener todos los IDs de los descendientes de un nodo.
        function getAllDescendants(parentId) {{
            var found = [];
            if (hierarchyMap[parentId]) {{
                hierarchyMap[parentId].forEach(function(child) {{
                    var childId = child.node.id;
                    if (nodes.get(childId)) {{
                        found.push(childId);
                        found = found.concat(getAllDescendants(childId));
                    }}
                }});
            }}
            return found;
        }}
    </script>
</body>
</html>
